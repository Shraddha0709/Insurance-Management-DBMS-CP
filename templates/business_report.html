<!-- templates/business_report.html -->
{% extends "base.html" %}
{% block title %}Business Report - IMS{% endblock %}

{% block content %}
<div class="flex justify-between mb-2">
    <h1>Business Report</h1>
    <div class="flex gap-1">
        <a href="{{ url_for('business_report', type='yearly') }}" 
           class="btn btn-sm {% if report_type == 'yearly' %}btn-primary{% else %}btn-secondary{% endif %}">
            Yearly
        </a>
        <a href="{{ url_for('business_report', type='monthly') }}" 
           class="btn btn-sm {% if report_type == 'monthly' %}btn-primary{% else %}btn-secondary{% endif %}">
            Monthly
        </a>
    </div>
</div>

<div class="card">
    <h3 class="card-header">{{ report_type|title }} Business Analytics</h3>
    {% if data %}
    <table>
        <thead>
            <tr>
                <th>Period</th>
                <th>Total Policies</th>
                <th>Total Commission (₹)</th>
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr>
                <td>{{ row.Period }}</td>
                <td>{{ row.Policy_Count }}</td>
                <td>₹{{ "{:,.2f}".format(row.Total_Commission) if row.Total_Commission else '0.00' }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="font-weight: bold; background: var(--light);">
                <td>Total</td>
                <td>{{ data|sum(attribute='Policy_Count') }}</td>
                <td>₹{{ "{:,.2f}".format(data|sum(attribute='Total_Commission') or 0) }}</td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <p class="text-center">No business data available yet.</p>
    {% endif %}
</div>

{% if data %}
<div class="card mt-2">
    <h3 class="card-header">Visual Analytics</h3>
    <canvas id="businessChart" style="max-height: 400px;"></canvas>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('businessChart').getContext('2d');
    const data = {{ data|tojson }};
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.Period),
            datasets: [{
                label: 'Total Policies',
                data: data.map(d => d.Policy_Count),
                backgroundColor: 'rgba(37, 99, 235, 0.5)',
                borderColor: 'rgba(37, 99, 235, 1)',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Total Commission (₹)',
                data: data.map(d => d.Total_Commission || 0),
                backgroundColor: 'rgba(16, 185, 129, 0.5)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Number of Policies' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Commission (₹)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}

